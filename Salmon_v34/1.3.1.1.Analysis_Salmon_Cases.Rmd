---
title: "Limma Analysis Salmon Cases"
author: "Gerard Temprano Sagrera"
date: "2022-12-16"
output: html_document
---

```{r, warning=FALSE, message=FALSE, echo = FALSE}
library(data.table);library(edgeR);library(tidyverse);library(openxlsx);library(preprocessCore);library(qvalue)
```

### Apply TPM transformation to salmon counts:

```{r}
# Load previously prepared salmon read counts:
counts <- fread("C://Users/Gerard/Desktop/AAA/RNAseq/Gene_counts/Counts.salmon.txt")
lengths <- fread("C://Users/Gerard/Desktop/AAA/RNAseq/Gene_counts/Lengths.txt")
lengths <- lengths$length/1000
rnames <- counts$V1
counts <- counts[,-1]
rownames(counts) <- rnames

r_tpm <- function(dfr,len)
{
  dfr1 <- sweep(dfr,1,len,`/`)
  sc.f <- colSums(dfr1)/(10^6)
  return(sweep(dfr1,2,sc.f,`/`))
}

counts.tpm <- as.data.frame(r_tpm(counts, lengths))
```

### Select only cases on technical variables:

```{r}
tec <- read.xlsx("C://Users/Gerard/Desktop/AAA/RNAseq/Tables/Technical_CompleteV2.xlsx")

# Select only cases:
tec <- tec[1:97,]
```

### Load Biological data to make comparissons:

```{r}
bio <- read.xlsx("C://Users/Gerard/Desktop/AAA/RNAseq/20221115_Datos Pacientes.xlsx")
bio <- bio[2:nrow(bio),]

bio <- bio[bio$Status == "Case",]

# Smoking:
table(bio$Smoking)
bio$Smoking2 <- ifelse(bio$Smoking == 0, 0, 1)
table(bio$Smoking2)

# Create BMI:
bio$BMI <- bio$Weight_Kg/((bio$Height_cm/100)^2)
bio$BMI.di <- ifelse(bio$BMI > 25, 1, 0)
bio$BMI.tri <- ifelse(bio$BMI > 30, 2, ifelse(bio$BMI > 25, 1, 0))
```

### Load Annotation file to change format names:

```{r}
ann <- fread("C://Users/Gerard/Desktop/AAA/RNAseq/Annotation/gencode.v34.annotation.fixed.gtf.gz")
```

### Select only cases:

```{r}
cases.tpm <- counts.tpm[,1:97]
```


## By size:

```{r}
# Remove lowly expressed genes using LIMMA:

dge <- DGEList(counts=cases.tpm)

design <- model.matrix(~bio$aortc_diameter_mm+tec$Date+tec$GC_Mean+tec$Batch)

colnames(design) <- c("(Intercept)", "Size", "Date202220829", "GC_Mean", "Plate")

keep <- filterByExpr(dge, design)

paste0("We keep ", sum(keep), " genes") # 9,252
paste0("We remove ", sum(!keep), " genes") # 27,460

dge <- dge[keep,,keep.lib.sizes=FALSE]

# Apply quantile normalization to  counts:

tpm.rows <- rownames(dge$counts)
tpm.cols <- colnames(dge$counts)

dge$counts <- as.data.frame(normalize.quantiles(as.matrix(dge$counts)))

rownames(dge$counts) <- tpm.rows
colnames(dge$counts) <- tpm.cols

# Differential Expression:

print(paste0("There are ", sum(is.na(bio$aortc_diameter_mm))," NAs"))
#table(bio$aortc_diameter_mm, useNA = "always")

Pvalue <- apply(dge$counts, 1, function(x) summary(lm(x~bio$aortc_diameter_mm+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,4])
Coef <- apply(dge$counts, 1, function(x) summary(lm(x~bio$aortc_diameter_mm+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,1])
```

```{r}
# Histogram of p-values:
hist(Pvalue)
```

```{r}
# Create qvalue object:
qobj <- qvalue(p = Pvalue)
```

```{r, warning=FALSE}
summary(qobj)
hist(qobj)
plot(qobj)
```

```{r}
Results.size <- data.frame(
  pvalue = Pvalue,
  qvalue = qobj$qvalues,
  fdr = p.adjust(Pvalue, method = "fdr"),
  pi1 = 1-qobj$pi0
)

Results.size <- merge(Results.size, ann[,c("gene_id","gene_name")], by.x = 0, by.y = "gene_id")
Results.size <- Results.size[,-1]
Results.size <- Results.size[!duplicated(Results.size$gene_name),]
Results.size <- Results.size %>% remove_rownames %>% column_to_rownames(var="gene_name")

Results.size[order(Results.size$pvalue), ][1:50,]
```


## By Age:

```{r}
# Remove lowly expressed genes using LIMMA:

dge <- DGEList(counts=cases.tpm)

design <- model.matrix(~bio$age+tec$Date+tec$GC_Mean+tec$Batch)

colnames(design) <- c("(Intercept)", "Age", "Date202220829", "GC_Mean", "Plate")

keep <- filterByExpr(dge, design)

paste0("We keep ", sum(keep), " genes") # 9,413
paste0("We remove ", sum(!keep), " genes") # 27,299

dge <- dge[keep,,keep.lib.sizes=FALSE]

# Apply quantile normalization to  counts:

tpm.rows <- rownames(dge$counts)
tpm.cols <- colnames(dge$counts)

dge$counts <- as.data.frame(normalize.quantiles(as.matrix(dge$counts)))

rownames(dge$counts) <- tpm.rows
colnames(dge$counts) <- tpm.cols

# Differential Expression:

print(paste0("There are ", sum(is.na(bio$age))," NAs"))
#table(bio$age, useNA = "always")

Pvalue <- apply(dge$counts, 1, function(x) summary(lm(x~bio$age+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,4])
Coef <- apply(dge$counts, 1, function(x) summary(lm(x~bio$age+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,1])
```

```{r}
# Histogram of p-values:
hist(Pvalue)
```


```{r}
# Create qvalue object:
qobj <- qvalue(p = Pvalue)
```

```{r, warning=FALSE}
summary(qobj)
hist(qobj)
plot(qobj)
```

```{r}
Results.age <- data.frame(
  pvalue = Pvalue,
  qvalue = qobj$qvalues,
  fdr = p.adjust(Pvalue, method = "fdr"),
  pi1 = 1-qobj$pi0
)

Results.age <- merge(Results.age, ann[,c("gene_id","gene_name")], by.x = 0, by.y = "gene_id")
Results.age <- Results.age[,-1]
Results.age <- Results.age[!duplicated(Results.age$gene_name),]
Results.age <- Results.age %>% remove_rownames %>% column_to_rownames(var="gene_name")

Results.age[order(Results.age$pvalue), ][1:50,]
```



## By Type of Aneurysm (1 Atherosclerotic 2 Inflammatory):

```{r}
# Remove lowly expressed genes using LIMMA:

dge <- DGEList(counts=cases.tpm)

design <- model.matrix(~bio$TIPOANEURISMA+tec$Date+tec$GC_Mean+tec$Batch)

colnames(design) <- c("(Intercept)", "Type", "Date202220829", "GC_Mean", "Plate")

keep <- filterByExpr(dge, design)

paste0("We keep ", sum(keep), " genes") # 9,602
paste0("We remove ", sum(!keep), " genes") # 27,110

dge <- dge[keep,,keep.lib.sizes=FALSE]

# Apply quantile normalization to  counts:

tpm.rows <- rownames(dge$counts)
tpm.cols <- colnames(dge$counts)

dge$counts <- as.data.frame(normalize.quantiles(as.matrix(dge$counts)))

rownames(dge$counts) <- tpm.rows
colnames(dge$counts) <- tpm.cols

# Differential Expression:

print(paste0("There are ", sum(is.na(bio$TIPOANEURISMA))," NAs"))
table(bio$TIPOANEURISMA, useNA = "always")

Pvalue <- apply(dge$counts, 1, function(x) summary(lm(x~bio$TIPOANEURISMA+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,4])
Coef <- apply(dge$counts, 1, function(x) summary(lm(x~bio$TIPOANEURISMA+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,1])
```

```{r}
# Histogram of p-values:
hist(Pvalue)
```

```{r}
# Create qvalue object:
qobj <- qvalue(p = Pvalue)
```

```{r, warning=FALSE}
summary(qobj)
hist(qobj)
plot(qobj)
```

```{r}
Results.type <- data.frame(
  pvalue = Pvalue,
  qvalue = qobj$qvalues,
  fdr = p.adjust(Pvalue, method = "fdr"),
  pi1 = 1-qobj$pi0
)

Results.type <- merge(Results.type, ann[,c("gene_id","gene_name")], by.x = 0, by.y = "gene_id")
Results.type <- Results.type[,-1]
Results.type <- Results.type[!duplicated(Results.type$gene_name),]
Results.type <- Results.type %>% remove_rownames %>% column_to_rownames(var="gene_name")

Results.type[order(Results.type$pvalue), ][1:20,]
```



## By Type of Aneurysm (0 Symptomathic 1 Asymptomathic):

```{r}
# Remove lowly expressed genes using LIMMA:

dge <- DGEList(counts=cases.tpm)

design <- model.matrix(~bio$symptomatic+tec$Date+tec$GC_Mean+tec$Batch)

colnames(design) <- c("(Intercept)", "Type", "Date202220829", "GC_Mean", "Plate")

keep <- filterByExpr(dge, design)

paste0("We keep ", sum(keep), " genes") # 9,602
paste0("We remove ", sum(!keep), " genes") # 27,110

dge <- dge[keep,,keep.lib.sizes=FALSE]

# Apply quantile normalization to  counts:

tpm.rows <- rownames(dge$counts)
tpm.cols <- colnames(dge$counts)

dge$counts <- as.data.frame(normalize.quantiles(as.matrix(dge$counts)))

rownames(dge$counts) <- tpm.rows
colnames(dge$counts) <- tpm.cols

# Differential Expression:

print(paste0("There are ", sum(is.na(bio$symptomatic))," NAs"))
table(bio$TIPOANEURISMA, useNA = "always")

Pvalue <- apply(dge$counts, 1, function(x) summary(lm(x~bio$symptomatic+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,4])
Coef <- apply(dge$counts, 1, function(x) summary(lm(x~bio$symptomatic+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,1])
```

```{r}
# Histogram of p-values:
hist(Pvalue)
```

```{r}
# Create qvalue object:
qobj <- qvalue(p = Pvalue)
```

```{r, warning=FALSE}
summary(qobj)
hist(qobj)
plot(qobj)
```

```{r}
Results.type <- data.frame(
  pvalue = Pvalue,
  qvalue = qobj$qvalues,
  fdr = p.adjust(Pvalue, method = "fdr"),
  pi1 = 1-qobj$pi0
)

Results.type <- merge(Results.type, ann[,c("gene_id","gene_name")], by.x = 0, by.y = "gene_id")
Results.type <- Results.type[,-1]
Results.type <- Results.type[!duplicated(Results.type$gene_name),]
Results.type <- Results.type %>% remove_rownames %>% column_to_rownames(var="gene_name")

Results.type[order(Results.type$pvalue), ][1:40,]
```


## By Smoking (0 Never 1 Has smoked):

```{r}
# Remove lowly expressed genes using LIMMA:

dge <- DGEList(counts=cases.tpm)

design <- model.matrix(~bio$Smoking2+tec$Date+tec$GC_Mean+tec$Batch)

colnames(design) <- c("(Intercept)", "Smkoking", "Date202220829", "GC_Mean", "Plate")

keep <- filterByExpr(dge, design)

paste0("We keep ", sum(keep), " genes") # 9,602
paste0("We remove ", sum(!keep), " genes") # 27,110

dge <- dge[keep,,keep.lib.sizes=FALSE]

# Apply quantile normalization to  counts:

tpm.rows <- rownames(dge$counts)
tpm.cols <- colnames(dge$counts)

dge$counts <- as.data.frame(normalize.quantiles(as.matrix(dge$counts)))

rownames(dge$counts) <- tpm.rows
colnames(dge$counts) <- tpm.cols

# Differential Expression:

print(paste0("There are ", sum(is.na(bio$symptomatic))," NAs"))
table(bio$TIPOANEURISMA, useNA = "always")

Pvalue <- apply(dge$counts, 1, function(x) summary(lm(x~bio$Smoking2+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,4])
Coef <- apply(dge$counts, 1, function(x) summary(lm(x~bio$Smoking2+tec$Date+tec$GC_Mean+tec$Batch))[4][[1]][2,1])
```

```{r}
# Histogram of p-values:
hist(Pvalue)
```

```{r}
# Create qvalue object:
qobj <- qvalue(p = Pvalue)
```

```{r, warning=FALSE}
summary(qobj)
hist(qobj)
plot(qobj)
```

```{r}
Results.smoking <- data.frame(
  pvalue = Pvalue,
  qvalue = qobj$qvalues,
  fdr = p.adjust(Pvalue, method = "fdr"),
  pi1 = 1-qobj$pi0
)

Results.smoking <- merge(Results.smoking, ann[,c("gene_id","gene_name")], by.x = 0, by.y = "gene_id")
Results.smoking <- Results.smoking[,-1]
Results.smoking <- Results.smoking[!duplicated(Results.smoking$gene_name),]
Results.smoking <- Results.smoking %>% remove_rownames %>% column_to_rownames(var="gene_name")

Results.smoking[order(Results.smoking$pvalue), ][1:40,]
```














### DEG by Aneurysm Size:

```{r}
dge <- DGEList(counts=cases.tpm)

design <- model.matrix(~bio$aortc_diameter_mm+tec$Date+tec$GC_Mean+tec$Batch)

colnames(design) <- c("(Intercept)", "Size", "Date202220829", "GC_Mean", "Plate")
```

### Remove lowely expressed genes:

```{r}
keep <- filterByExpr(dge, design)

paste0("We keep ", sum(keep), " genes")
paste0("We remove ", sum(!keep), " genes")

dge <- dge[keep,,keep.lib.sizes=FALSE]
```

### Remove NAs:

```{r}
keep <- !is.na(bio$aortc_diameter_mm)

paste("There are", sum(!keep), "NAs")

dge2 <- dge[,keep]
```

### Apply TMM Normalization:

```{r}
dge2 <- calcNormFactors(dge2, method = "TMM")
```

```{r}
v <- voom(dge2, design, plot = TRUE)

# Limma Differential Expression:

fit <- lmFit(v, design)
fit <- eBayes(fit)

# Obtain differentially expressed genes between all conditions:

summary(decideTests(fit))
```


